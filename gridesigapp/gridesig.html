<!DOCTYPE html>
<html>
<body onload="myFunction()">

<input type="file" id="myFile" multiple size="50" onchange="myFunction()">
<p><strong>Tip:</strong> Use the Control or the Shift key to select multiple files.</p>
<br>
<div id="tile_bar" style="width: 128px;float: left;">
<form>
<div id="tiles"></div> 
</form>

<p id="outputmsg"></p>
</div> 

<canvas id="myCanvas" width="1024" height="800" style="border:1px solid #000000;">
Your browser does not support the HTML canvas tag.
</canvas>

 
<script>
const icon_res = 64;

var tile_IDs = [];

var file_array = [];
var file_names = [];
var elem = document.getElementById('myCanvas'),
    elemLeft = elem.offsetLeft + elem.clientLeft,
    elemTop = elem.offsetTop + elem.clientTop,
    context = elem.getContext('2d');
// Add event listener for `click` events to the CANVAS
elem.addEventListener('click', function(event) {
    var x = event.pageX - elemLeft,
        y = event.pageY - elemTop;
        
    const rbs = document.querySelectorAll('input[name="tile"]');
    let selectedValue;
    for (const rb of rbs) {
        if (rb.checked) {
           selectedValue = rb.value;
           break;
        }
    }
    if (typeof selectedValue !== 'undefined'){

		console.log("canvasID"+selectedValue);
		var img_canv = document.getElementById("canvasID"+selectedValue);
		context.drawImage(img_canv, icon_res, icon_res);
	}
}, false);


function readNextFile(index, files){
	if (files.length > index){
		var file = files[index];
        if ('size' in file) {
			var fr = new FileReader(); 
			fr.readAsText(file); 
			fr.onload=function(){ 
				file_array.push(fr.result);
				file_names.push(file.name);
				readNextFile(++index, files);
                //console.log(fr.result);
                if (index == files.length)
					addToTileList(-1);
            } 
        }
     }
}

var s, filename, myArr;

function addToTileList(index){
	//console.log("index ="+index);
	//for(i = 0, len = file_array.length; i < len; i++){
	
	//console.log("file_array len="+file_array.length);
		
		if ((index < 0) && (file_array.length > 0)){
			s = file_array.pop();
			filename = file_names.pop();
			
			myArr = JSON.parse(s);
			
			console.log("myArr len="+myArr.tiles.length);
			
			index = myArr.tiles.length - 1;
		} else if (index < 0) {
			return 0;
		}	

		var url = ""
		var name = ""
		var width, height, vOffset, hOffset;
		
		//console.log("tile ="+myArr.tiles[index]);
		
			var js = JSON.parse(JSON.stringify(myArr.tiles[index]), function (key, value) {
			//console.log(key);
			  if (key == "src") {
				url = value;
				//console.log(result);
			  } 
			  if (key == "ID") {
				name = value;
				//console.log(result);
			  } 
			  if (key == "width") {
				width = value;
			  } 
			  if (key == "height") {
				height = value;
			  } 
			  if (key == "hOffset") {
				hOffset = value;
			  } 
			  if (key == "vOffset") {
				vOffset = value;
			  } 
			  return 0;
			});
		/**/
		//console.log(url);
		
		if (url != ""){
			var img = new Image();
			img.src = url;//URL.createObjectURL(e.target.files[0]);
			
			
			
			img.onload = function() {
			
			console.log(tile_IDs);
			console.log(tile_IDs.includes(name));
			
				if (!tile_IDs.includes(name)){
				
					tile_IDs.push(name);
				
					var canvas = document.createElement('canvas');
					canvas.setAttribute("id", "canvasID"+name);
					
					var ctx = canvas.getContext('2d');
					canvas.width = icon_res;//img.width;
					canvas.height = icon_res;// img.height;
					var oc = document.createElement('canvas'),
						octx = oc.getContext('2d');
						oc.setAttribute("id", "ocID"+name);

					oc.width = width;//img.width * 0.5;
					oc.height = height;//img.height * 0.5;
					octx.drawImage(img, hOffset, vOffset, width, height, 0, 0, width, height);
					ctx.drawImage(oc, 0, 0, canvas.width, canvas.height);
					
					//console.log("canvasID"+name);
					
					var newDiv = document.createElement("div");
					// and give it some content
					
					radioHtml = "<input type=\"radio\" name=\"tile\"  value=\""+name+"\" ><label for=\""+filename+"\">"+filename+"</label></div></div>";
					var canvasDiv = document.createElement("div");
					canvasDiv.style.cssFloat = "none";
					newDiv.style.border = "thin groove #AAAAAA";
					var newContent = document.createElement("div");
					// add the text node to the newly created div
					newContent.innerHTML = radioHtml;
					canvasDiv.appendChild(canvas);
					newDiv.appendChild(canvasDiv);
					newDiv.appendChild(document.createTextNode(name));
					newDiv.appendChild(newContent);
					document.getElementById('tiles').appendChild(newDiv); 
				
				} else {
					var txt = "tile with ID "+name+" already in the list.";
				}
				
				addToTileList(--index);
				document.getElementById("outputmsg").innerHTML += txt; 
				
			/*	
				document.getElementById("tiles").innerHTML += "<div style=\"margin-top:30px;border-style: groove;\"><div style=\"width:"+width+"px;height:"+height+"px;overflow:hidden;\"><img id=\""+
														filename+"\" src=\""+ dataurl +"\" style=\"float:clear;width:"+width+"px;height:"+height+"px;margin:-"+vOffset+"px "+(image_width-hOffset-width)+"px "+(image_height-vOffset-height)+"px -"+hOffset+"px\"> <div> <div> " + name + "<br>"
														+ "<input type=\"radio\" name=\"tile\" id=\""+name+"\" value=\""+filename+"\" ><label for=\""+filename+"\">"+filename+"</label></div></div>";
	*/
			}
		}
}

function myFunction(){
  var x = document.getElementById("myFile");
  var txt = "";
  if ('files' in x) {
    if (x.files.length == 0) {
      txt = "Select one or more files.";
    } else {
      for (var i = 0; i < x.files.length; i++) {
        txt += "<br><strong>" + (i+1) + ". tile</strong><br>";
        var file = x.files[i];
        if ('name' in file) {
          txt += "name: " + file.name + "<br>";
        }
      }
      readNextFile(0, x.files)
    }
  } else {
    if (x.value == "") {
      txt += "Select one or more files.";
    } else {
      txt += "The files property is not supported by your browser!";
      txt  += "<br>The path of the selected file: " + x.value; // If the browser does not support the files property, it will return the path of the selected file instead. 
    }
  }
  document.getElementById("outputmsg").innerHTML = txt; 
}
</script>

</body>
</html>
